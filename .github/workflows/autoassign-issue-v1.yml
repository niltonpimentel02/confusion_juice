name: Autoassign issue

on:
  workflow_call:
  issue_comment:
    types:
      - created

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  issue_assign:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null
    concurrency:
      group: ${{ github.actor }}-issue-assign
      cancel-in-progress: true

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ASSIGNEE: ${{ github.event.comment.user.login }}
      CONTRIBUTING_URL: https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md

    steps:
      - name: Check if comment matches trigger words
        id: check_comment
        env:
          COMMENT: "${{ github.event.comment.body }}"
        run: |
          normalized_comment=$(echo "$COMMENT" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')

          triggers=("bora" "bora!" "dibs" "dibs!")

          should_assign=false
          for word in "${triggers[@]}"; do
            if [[ "$normalized_comment" == "$word" ]]; then
              should_assign=true
              break
            fi
          done

          echo "should_assign=$should_assign" >> "$GITHUB_OUTPUT"

      - name: Check if issue already has assignees
        id: check_existing_assignees
        if: steps.check_comment.outputs.should_assign == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch issue details and count assignees
          issue_json=$(curl -sSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER)

          assignee_count=$(echo "$issue_json" | jq '.assignees | length')

          if [[ "$assignee_count" -ge 1 ]]; then
            echo "already_assigned=true" >> "$GITHUB_OUTPUT"
          else
            echo "already_assigned=false" >> "$GITHUB_OUTPUT"
          fi

          # Build a comma-separated string of @logins of current assignees
          assignee_logins=$(echo "$issue_json" | jq -r '[.assignees[].login] | map("@"+.) | join(", ")')
          # If empty, set a friendly fallback
          if [[ -z "$assignee_logins" || "$assignee_logins" == "null" ]]; then
            assignee_logins="(no assignees)"
          fi

          echo "assignee_logins=$assignee_logins" >> "$GITHUB_OUTPUT"

      - name: Assign issue to commenter
        if: steps.check_comment.outputs.should_assign == 'true' && steps.check_existing_assignees.outputs.already_assigned == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::notice::Assigning issue #$ISSUE_NUMBER to $ASSIGNEE"

          curl -sSL \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/assignees \
            -d '{"assignees":["'${ASSIGNEE}'"]}'

      - name: Create Comment (assignment success)
        if: steps.check_comment.outputs.should_assign == 'true' && steps.check_existing_assignees.outputs.already_assigned == 'false'
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          issue-number: ${{ env.ISSUE_NUMBER }}
          body: |
            ğŸ‡§ğŸ‡· **PortuguÃªs**
            âœ… Issue #${{ github.event.issue.number }} atribuÃ­da a @${{ github.event.comment.user.login }}. Verifique o [guia de contribuiÃ§Ã£o](${{ env.CONTRIBUTING_URL }}) para instruÃ§Ãµes sobre como submeter sua Pull Request.

            ğŸ‡¬ğŸ‡§ **English**
            âœ… Issue #${{ github.event.issue.number }} assigned to @${{ github.event.comment.user.login }}. Check the [contributing guide](${{ env.CONTRIBUTING_URL }}) for instructions on submitting your Pull Request.

      - name: Create Comment (already assigned)
        if: steps.check_comment.outputs.should_assign == 'true' && steps.check_existing_assignees.outputs.already_assigned == 'true'
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          issue-number: ${{ env.ISSUE_NUMBER }}
          body: |
            ğŸ‡§ğŸ‡· **PortuguÃªs**
            âš ï¸ Issue #${{ github.event.issue.number }} jÃ¡ estÃ¡ atribuÃ­da a ${{ steps.check_existing_assignees.outputs.assignee_logins }}. Se vocÃª acredita que deveria ser reatribuÃ­da, converse com a pessoa atual ou com os mantenedores.

            ğŸ‡¬ğŸ‡§ **English**
            âš ï¸ Issue #${{ github.event.issue.number }} is already assigned to ${{ steps.check_existing_assignees.outputs.assignee_logins }}. If you think it should be reassigned, please coordinate with the current assignee or the maintainers.
